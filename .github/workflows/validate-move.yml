name: Validate Move

on:
  pull_request:
    branches: [main]
    paths:
      - 'tribes/**/strategy.py'

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for diff comparison

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Determine tribe and validate files
        id: detect-tribe
        uses: actions/github-script@v7
        with:
          script: |
            // Get changed files from the PR
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const changedFiles = files.map(f => f.filename);
            console.log('Changed files:', changedFiles);

            // Check for invalid file changes
            const invalidFiles = changedFiles.filter(f => {
              // Only allow strategy.py files in tribes directories
              if (f.match(/^tribes\/(red|blue|green|yellow)\/strategy\.py$/)) {
                return false; // This is allowed
              }
              // Everything else is invalid
              return true;
            });

            if (invalidFiles.length > 0) {
              console.log('Invalid files detected:', invalidFiles);
              core.setOutput('invalid_files', invalidFiles.join(', '));
              core.setOutput('has_invalid_files', 'true');
            } else {
              core.setOutput('has_invalid_files', 'false');
            }

            let tribe = '';
            for (const file of changedFiles) {
              if (file.includes('tribes/red/')) {
                tribe = 'RED';
                break;
              } else if (file.includes('tribes/blue/')) {
                tribe = 'BLUE';
                break;
              } else if (file.includes('tribes/green/')) {
                tribe = 'GREEN';
                break;
              } else if (file.includes('tribes/yellow/')) {
                tribe = 'YELLOW';
                break;
              }
            }

            console.log('Detected tribe:', tribe);
            core.setOutput('tribe', tribe);

      - name: Reject invalid file changes
        if: steps.detect-tribe.outputs.has_invalid_files == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const invalidFiles = '${{ steps.detect-tribe.outputs.invalid_files }}';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ùå Invalid File Changes Detected

This PR modifies files that are not allowed:

\`\`\`
${invalidFiles}
\`\`\`

**Only \`tribes/{tribe}/strategy.py\` files can be modified.**

Please remove all other file changes and try again. Common issues:
- \`__pycache__\` files should not be committed
- Engine files should not be modified
- Game state files should not be modified`
            });

            core.setFailed('PR contains invalid file changes: ' + invalidFiles);

      - name: Validate move
        id: validate
        if: steps.detect-tribe.outputs.tribe != '' && steps.detect-tribe.outputs.has_invalid_files != 'true'
        working-directory: engine
        run: |
          python main.py validate \
            --state ../data/gamestate.json \
            --tribe ${{ steps.detect-tribe.outputs.tribe }} \
            2>&1 | tee validation_output.txt

          # Capture exit code
          exit_code=${PIPESTATUS[0]}
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT

          # Read output for comment
          OUTPUT=$(cat validation_output.txt)
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate preview diff
        if: steps.validate.outputs.exit_code == '0'
        working-directory: engine
        run: |
          # Run the turn to generate diff.json (without saving)
          python main.py run \
            --state ../data/gamestate.json \
            --tribe ${{ steps.detect-tribe.outputs.tribe }} \
            --output ../diff.json \
            --dry-run || true

      - name: Comment on PR - Success
        if: steps.validate.outputs.exit_code == '0'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.validate.outputs.output }}`;
            const tribe = '${{ steps.detect-tribe.outputs.tribe }}';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚úÖ Move Validated for ${tribe} Tribe

            \`\`\`
            ${output}
            \`\`\`

            The move is valid and ready to be merged. Once merged, the game state will be updated.

            üéÆ [View Game](https://your-game-url.vercel.app)`
            });

      - name: Comment on PR - Failure
        if: steps.validate.outputs.exit_code != '0' && steps.validate.outputs.exit_code != ''
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.validate.outputs.output }}`;
            const tribe = '${{ steps.detect-tribe.outputs.tribe }}';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ùå Invalid Move for ${tribe} Tribe

            \`\`\`
            ${output}
            \`\`\`

            Please fix the issues above and push a new commit.

            ### Common Issues:
            - Syntax errors in strategy.py
            - Invalid action format
            - Moving to an invalid position
            - Not your turn
            - Insufficient resources`
            });

      - name: Fail if validation failed
        if: steps.validate.outputs.exit_code != '0' && steps.validate.outputs.exit_code != ''
        run: exit 1
