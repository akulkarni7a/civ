name: Auto-Merge Tribe PRs

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'tribes/**/strategy.py'
  check_suite:
    types: [completed]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    # Only run on PRs that modify tribe strategies
    if: github.event_name == 'pull_request' || (github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if PR should be auto-merged
        id: check-pr
        run: |
          # Get the PR number
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            PR_NUMBER=${{ github.event.pull_request.number }}
          else
            # For check_suite events, find the PR from the head SHA
            PR_NUMBER=$(gh pr list --json number,headRefOid --jq ".[] | select(.headRefOid == \"${{ github.event.check_suite.head_sha }}\") | .number")
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          if [ -z "$PR_NUMBER" ]; then
            echo "No PR found"
            echo "should_merge=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if PR modifies tribe strategies
          FILES=$(gh pr diff $PR_NUMBER --name-only 2>/dev/null || echo "")

          if echo "$FILES" | grep -q "tribes/.*/strategy.py"; then
            echo "PR modifies tribe strategies, checking for auto-merge"

            # Check if the PR title indicates it's a tribe strategy PR
            TITLE=$(gh pr view $PR_NUMBER --json title -q .title)
            # Accept: [RED], [BLUE], or titles with "RED Tribe", "BLUE Tribe", etc.
            if echo "$TITLE" | grep -qE "(\[(RED|BLUE|GREEN|YELLOW)\]|(RED|BLUE|GREEN|YELLOW) Tribe)"; then
              echo "PR is a tribe strategy PR, enabling auto-merge"
              echo "should_merge=true" >> $GITHUB_OUTPUT
            else
              echo "PR title doesn't match tribe pattern: $TITLE"
              echo "should_merge=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "PR does not modify tribe strategies"
            echo "should_merge=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for checks to pass
        if: steps.check-pr.outputs.should_merge == 'true'
        id: wait-checks
        run: |
          PR_NUMBER=${{ steps.check-pr.outputs.pr_number }}

          echo "Waiting for all checks to pass on PR #$PR_NUMBER..."

          # Wait up to 5 minutes for checks
          MAX_ATTEMPTS=30
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            CHECKS=$(gh pr checks $PR_NUMBER --json state 2>/dev/null || echo "")

            # Check if all checks passed
            FAILED=$(echo "$CHECKS" | jq '[.[] | select(.state == "FAILURE")] | length' 2>/dev/null || echo "0")
            PENDING=$(echo "$CHECKS" | jq '[.[] | select(.state == "PENDING" or .state == "QUEUED" or .state == "IN_PROGRESS")] | length' 2>/dev/null || echo "0")

            if [ "$FAILED" -gt 0 ]; then
              echo "Some checks failed, cannot auto-merge"
              echo "checks_passed=false" >> $GITHUB_OUTPUT
              exit 0
            fi

            if [ "$PENDING" -eq 0 ]; then
              echo "All checks passed!"
              echo "checks_passed=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "Waiting for $PENDING checks to complete (attempt $ATTEMPT/$MAX_ATTEMPTS)..."
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "Timeout waiting for checks"
          echo "checks_passed=false" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Mark PR as ready for review
        if: steps.check-pr.outputs.should_merge == 'true' && steps.wait-checks.outputs.checks_passed == 'true'
        run: |
          PR_NUMBER=${{ steps.check-pr.outputs.pr_number }}

          # Check if PR is a draft
          IS_DRAFT=$(gh pr view $PR_NUMBER --json isDraft -q .isDraft)

          if [ "$IS_DRAFT" == "true" ]; then
            echo "Converting draft PR to ready for review..."
            gh pr ready $PR_NUMBER
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge
        if: steps.check-pr.outputs.should_merge == 'true' && steps.wait-checks.outputs.checks_passed == 'true'
        run: |
          PR_NUMBER=${{ steps.check-pr.outputs.pr_number }}

          echo "Merging PR #$PR_NUMBER..."

          # Merge the PR
          gh pr merge $PR_NUMBER --squash --auto --delete-branch || {
            # If auto-merge fails, try direct merge
            echo "Auto-merge not available, attempting direct merge..."
            gh pr merge $PR_NUMBER --squash --delete-branch
          }

          echo "PR #$PR_NUMBER merged successfully!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR
        if: steps.check-pr.outputs.should_merge == 'true' && steps.wait-checks.outputs.checks_passed == 'true'
        run: |
          PR_NUMBER=${{ steps.check-pr.outputs.pr_number }}

          gh pr comment $PR_NUMBER --body "ðŸŽ® **Git-vilization Auto-Merge**

          This PR was automatically merged because:
          - âœ… It modifies a tribe strategy file
          - âœ… All validation checks passed
          - âœ… The PR is from Jules AI

          The game state will be updated in the next workflow run."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
