name: Apply Move

on:
  push:
    branches: [main]
    paths:
      - 'tribes/**/strategy.py'

jobs:
  apply:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect changes

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Determine tribe from changed files
        id: detect-tribe
        run: |
          # Get the tribe from the changed file path
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files: $CHANGED_FILES"

          TRIBE=""
          if echo "$CHANGED_FILES" | grep -q "tribes/red/"; then
            TRIBE="RED"
          elif echo "$CHANGED_FILES" | grep -q "tribes/blue/"; then
            TRIBE="BLUE"
          elif echo "$CHANGED_FILES" | grep -q "tribes/green/"; then
            TRIBE="GREEN"
          elif echo "$CHANGED_FILES" | grep -q "tribes/yellow/"; then
            TRIBE="YELLOW"
          fi

          echo "tribe=$TRIBE" >> $GITHUB_OUTPUT
          echo "Detected tribe: $TRIBE"

      - name: Apply move
        if: steps.detect-tribe.outputs.tribe != ''
        working-directory: engine
        run: |
          python main.py run \
            --state ../data/gamestate.json \
            --tribe ${{ steps.detect-tribe.outputs.tribe }} \
            --output ../diff.json

      - name: Commit updated game state
        if: steps.detect-tribe.outputs.tribe != ''
        run: |
          git config --local user.email "game-engine@gitvilization.dev"
          git config --local user.name "Git-vilization Game Engine"

          git add data/gamestate.json diff.json
          git commit -m "ðŸŽ® Applied move for ${{ steps.detect-tribe.outputs.tribe }} Tribe

          Turn completed. Game state updated.

          ðŸ¤– Generated by Git-vilization Game Engine" || echo "No changes to commit"

          git push

      - name: Determine next tribe
        id: next-tribe
        if: steps.detect-tribe.outputs.tribe != ''
        run: |
          # Read the current tribe from the updated game state
          NEXT_TRIBE=$(python3 -c "
          import json
          with open('data/gamestate.json') as f:
              state = json.load(f)
          print(state['currentTribe'])
          ")
          echo "next_tribe=$NEXT_TRIBE" >> $GITHUB_OUTPUT
          echo "Next tribe: $NEXT_TRIBE"

      - name: Trigger next tribe (Jules webhook)
        if: steps.next-tribe.outputs.next_tribe != ''
        env:
          JULES_WEBHOOK_URL: ${{ secrets.JULES_WEBHOOK_URL }}
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          if [ -n "$JULES_WEBHOOK_URL" ]; then
            curl -X POST "$JULES_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $JULES_API_KEY" \
              -d '{
                "tribe": "${{ steps.next-tribe.outputs.next_tribe }}",
                "turn": '"$(python3 -c "import json; print(json.load(open('data/gamestate.json'))['turn'])")"',
                "game_id": "'"$(python3 -c "import json; print(json.load(open('data/gamestate.json'))['gameId'])")"'
              }'
            echo "Triggered Jules for ${{ steps.next-tribe.outputs.next_tribe }}"
          else
            echo "Jules webhook not configured, skipping trigger"
          fi
